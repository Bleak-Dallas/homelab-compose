services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    network_mode: "host" # DLNA/auto-discovery friendly
    user: "${PUID}:${PGID}" # run as your host user
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - JELLYFIN_PublishedServerUrl=${PUBLISHED_URL} # optional
      - UMASK=${UMASK}
      - LIBVA_DRIVER_NAME=radeonsi # force AMD VAAPI driver (radeonsi = AMD on Mesa)
      - VAAPI_DEVICE=/dev/dri/renderD128 # tell Jellyfin/FFmpeg which VAAPI node to use
    devices:
      - /dev/dri:/dev/dri # expose GPU device files (card*/renderD*)
    group_add:
      - "render" # allow access to /dev/dri/renderD*
      - "video" # allow access to /dev/dri/card*
    volumes:
      - ${JF_CONFIG}:/config
      - ${JF_CACHE}:/cache
      - type: bind
        source: ${MEDIA_1}
        target: /media
        read_only: true
      - type: bind
        source: ${FONTS_DIR}
        target: /usr/local/share/fonts/custom
        read_only: true
    tmpfs:
      - /transcode:size=${TRANSCODE_TMPFS_SIZE} # fast, RAM-backed transcodes
    healthcheck:
      test:
        [
          "CMD",
          "bash",
          "-c",
          "curl -fsS http://127.0.0.1:8096/health || exit 1",
        ]
      interval: 30s
      timeout: 5s
      retries: 10
    extra_hosts:
      - "host.docker.internal:host-gateway"
    profiles: ["gpu"] # run with: docker compose --profile gpu up -d

